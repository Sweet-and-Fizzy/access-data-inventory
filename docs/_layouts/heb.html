<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }} - ACCESS Data Inventory</title>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Archivo:ital,wdth,wght@0,70,400;0,100,400;0,100,500;0,100,600;0,100,700;0,100,800;1,100,400&display=swap"
  />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --access-teal: #008597;
      --access-teal-light: #48c0b9;
      --access-yellow: #ffc42d;
      --access-orange: #f07537;
      --access-dark: #232323;
      --access-gray: #636363;
      --access-light: #f2f2f2;
    }

    body {
      font-family: "Archivo", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: white;
      color: var(--access-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ACCESS UI components will render in these divs */
    #universal-menus, #header, #site-menus, #breadcrumbs, #footer {
      width: 100%;
    }

    .page-header {
      background: white;
      padding: 40px 20px 20px;
      border-bottom: 1px solid #ddd;
    }

    .page-header h1 {
      font-size: 36px;
      font-stretch: 70%;
      font-weight: 500;
      color: var(--access-dark);
      margin-bottom: 10px;
    }

    .main-container {
      display: flex;
      flex: 1;
    }

    .sidebar {
      width: 280px;
      padding: 20px;
      background: white;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--access-gray);
      margin-bottom: 15px;
      font-weight: 600;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.85rem;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .controls {
      margin-top: 30px;
    }

    .controls label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: var(--access-gray);
      font-weight: 500;
    }

    .controls select {
      width: 100%;
      padding: 8px;
      background: var(--access-light);
      border: 1px solid #ddd;
      color: var(--access-dark);
      border-radius: 4px;
      font-size: 0.85rem;
      margin-bottom: 15px;
      font-family: inherit;
    }

    .info-panel {
      margin-top: 30px;
      padding: 15px;
      background: var(--access-light);
      border-radius: 6px;
      font-size: 0.85rem;
      display: none;
      max-height: calc(100vh - 350px);
      overflow-y: auto;
    }

    .info-panel.active {
      display: block;
    }

    .info-panel h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: var(--access-teal);
      font-weight: 600;
    }

    .info-panel p {
      color: var(--access-gray);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .info-panel .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .info-panel .tag {
      background: white;
      border: 1px solid #ddd;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 0.75rem;
    }

    .chart-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: white;
    }

    #chart {
      width: 100%;
      height: 100%;
      max-width: 800px;
      max-height: 800px;
    }

    .node text {
      font-size: 11px;
      font-family: "Archivo", sans-serif;
      fill: var(--access-gray);
      cursor: pointer;
      transition: fill 0.2s;
    }

    .node text:hover {
      fill: var(--access-dark);
    }

    .node--source text {
      fill: var(--access-orange);
      font-weight: 600;
    }

    .node--target text {
      fill: var(--access-teal);
      font-weight: 600;
    }

    .link {
      fill: none;
      stroke: #ddd;
      stroke-opacity: 0.6;
      stroke-width: 1.5;
      cursor: pointer;
      pointer-events: stroke;
    }

    .link--source,
    .link--target {
      stroke-opacity: 1;
      stroke-width: 2.5;
    }

    .link--source {
      stroke: var(--access-orange);
    }

    .link--target {
      stroke: var(--access-teal);
    }

    .node circle {
      transition: r 0.2s;
    }

    /* Canonical source dashed links */
    .link--canonical {
      stroke: var(--access-teal);
      stroke-dasharray: 6, 3;
      stroke-opacity: 0.8;
      stroke-width: 2;
    }

    .link--canonical.link--source,
    .link--canonical.link--target {
      stroke-opacity: 1;
      stroke-width: 3;
    }

    .link:hover {
      stroke-opacity: 1;
      stroke-width: 3;
    }

    /* FK highlight */
    .link--fk-highlight {
      stroke: var(--access-yellow);
      stroke-opacity: 1;
      stroke-width: 3;
      animation: fk-pulse 1.5s ease-in-out infinite;
    }

    @keyframes fk-pulse {
      0%, 100% { stroke-opacity: 0.7; }
      50% { stroke-opacity: 1; }
    }

    /* ERD-style field card in info panel */
    .field-card {
      margin-top: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    .field-card-header {
      background: var(--access-teal);
      color: white;
      padding: 6px 10px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-card-header a {
      color: white;
      text-decoration: underline;
      font-weight: 400;
      font-size: 0.7rem;
    }

    .field-card-body {
      max-height: 200px;
      overflow-y: auto;
    }

    .field-row {
      display: flex;
      padding: 3px 10px;
      font-size: 0.75rem;
      border-bottom: 1px solid #eee;
      align-items: center;
    }

    .field-row:last-child {
      border-bottom: none;
    }

    .field-row:nth-child(even) {
      background: #fafafa;
    }

    .field-name {
      flex: 1;
      font-family: monospace;
      font-size: 0.72rem;
      color: var(--access-dark);
    }

    .field-name .pk-badge {
      background: var(--access-teal);
      color: white;
      font-size: 0.55rem;
      padding: 1px 3px;
      border-radius: 2px;
      margin-left: 4px;
      font-family: "Archivo", sans-serif;
    }

    .field-name .fk-badge {
      background: var(--access-orange);
      color: white;
      font-size: 0.55rem;
      padding: 1px 3px;
      border-radius: 2px;
      margin-left: 4px;
      font-family: "Archivo", sans-serif;
      cursor: pointer;
    }

    .field-type {
      width: 65px;
      color: var(--access-gray);
      font-size: 0.7rem;
      text-align: center;
    }

    .field-access {
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 2px;
      text-align: center;
      width: 70px;
    }

    .field-access.public { background: #e0f5f3; color: #006d7a; }
    .field-access.authenticated { background: #fff3d0; color: #8a6d00; }
    .field-access.restricted { background: #fde8dd; color: #b84d1a; }
    .field-access.internal { background: #e8e8e8; color: #444; }
    .field-access.sensitive { background: #fdd; color: #c00; }

    /* Relationship list in info panel */
    .rel-list {
      margin-top: 12px;
    }

    .rel-list h4 {
      font-size: 0.8rem;
      color: var(--access-gray);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .rel-item {
      font-size: 0.75rem;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      line-height: 1.4;
    }

    .rel-item:last-child {
      border-bottom: none;
    }

    .rel-type-badge {
      display: inline-block;
      font-size: 0.65rem;
      padding: 1px 5px;
      border-radius: 2px;
      background: var(--access-light);
      border: 1px solid #ddd;
      margin-right: 4px;
      font-weight: 600;
    }

    .canonical-badge {
      display: inline-block;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--access-teal);
      color: white;
      margin-left: 6px;
    }

    .derived-badge {
      display: inline-block;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--access-orange);
      color: white;
      margin-left: 6px;
    }

    /* Edge info panel (when clicking a connection) */
    .edge-info h3 {
      font-size: 0.95rem;
    }

    .edge-info .edge-detail {
      font-size: 0.8rem;
      color: var(--access-gray);
      margin: 6px 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div id="universal-menus"></div>
  <div id="header"></div>
  <div id="site-menus"></div>
  <div id="breadcrumbs"></div>

  <div class="page-header">
    <h1>{{ page.title }}</h1>
    <p>Interactive visualization showing relationships between data sources. Click nodes to view fields and schema details. Click connections to view relationship metadata. Dashed lines indicate canonical source links.</p>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <h2>Legend - By Track</h2>
      <div id="legend"></div>

      <div class="controls">
        <label for="groupBy">Group nodes by:</label>
        <select id="groupBy">
          <option value="track">Track</option>
          <option value="category">Category</option>
          <option value="access_level">Access Level</option>
          <option value="type">Node Type</option>
        </select>

        <label for="tension">Bundle tension:</label>
        <select id="tension">
          <option value="0.85">High (0.85)</option>
          <option value="0.5">Medium (0.5)</option>
          <option value="0.15">Low (0.15)</option>
        </select>
      </div>

      <div class="info-panel" id="infoPanel">
        <h3 id="infoName">Select a node</h3>
        <p id="infoDesc"></p>
        <div class="meta" id="infoMeta"></div>
      </div>
    </div>

    <div class="chart-container">
      <svg id="chart"></svg>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import {
      breadcrumbs,
      footer,
      header,
      siteMenus,
      universalMenus,
    } from "https://unpkg.com/@access-ci/ui@0.16.0/dist/access-ci-ui.js";

    // Render ACCESS UI components
    universalMenus({
      siteName: "Data Inventory",
      target: document.getElementById("universal-menus"),
    });

    header({
      siteName: "Data Inventory",
      target: document.getElementById("header"),
    });

    siteMenus({
      siteName: "Data Inventory",
      target: document.getElementById("site-menus"),
      items: [
        { name: "Overview", href: "./" },
        { name: "Fields", href: "field-dictionary" },
        { name: "Connections", href: "heb-visualization" },
        { name: "Schema", href: "erd" },
      ],
    });

    breadcrumbs({
      target: document.getElementById("breadcrumbs"),
      items: [
        { name: "Data Inventory", href: "./" },
        { name: "{{ page.title }}" },
      ],
    });

    footer({ target: document.getElementById("footer") });
  </script>

  <script>
    // Color schemes using ACCESS brand colors
    const colorSchemes = {
      track: {
        "Support": "#008597",      // teal
        "Operations": "#f07537",   // orange
        "MCP": "#48c0b9",          // teal light
        "Allocations": "#ffc42d",  // yellow
        "ACO": "#636363",          // gray
        "Inferred": "#999",
        "Unknown": "#ccc"
      },
      category: {
        "Community & Outreach": "#008597",
        "Events & Training": "#ffc42d",
        "Users & Identity": "#f07537",
        "Content Management": "#48c0b9",
        "MCP Tools": "#636363",
        "Junction Table": "#999",
        "Referenced Entity": "#ccc",
        "Unknown": "#ddd"
      },
      access_level: {
        "Public": "#48c0b9",
        "Authenticated": "#ffc42d",
        "Restricted": "#f07537",
        "Sensitive": "#e63946",
        "Varies": "#008597",
        "Internal Only": "#636363",
        "Unknown": "#ccc"
      },
      type: {
        "data_source": "#008597",
        "mcp": "#48c0b9",
        "junction": "#636363",
        "entity": "#999",
        "Unknown": "#ccc"
      }
    };

    let currentGroupBy = 'track';
    let currentTension = 0.85;
    let inventoryData = { nodes: [], edges: [] };

    // Load data from JSON file
    fetch('inventory.json')
      .then(response => response.json())
      .then(data => {
        inventoryData = buildVisualizationData(data);
        createVisualization();
      })
      .catch(err => {
        console.error('Failed to load inventory.json:', err);
        document.querySelector('.chart-container').innerHTML =
          '<p style="color: #e63946; padding: 40px;">Failed to load data. Make sure inventory.json is available.</p>';
      });

    // Transform inventory JSON into visualization nodes/edges
    function buildVisualizationData(data) {
      const nodes = [];
      const edges = [];
      const nodeIds = new Set();

      // Add all data sources as nodes (with full field/relationship data)
      for (const source of data.sources) {
        const nodeId = source.id;
        nodeIds.add(nodeId);
        nodes.push({
          id: nodeId,
          name: source.name || nodeId,
          description: source.description || '',
          category: source.category || 'Unknown',
          track: source.track || 'Unknown',
          access_level: source.access_level || 'Unknown',
          type: 'data_source',
          has_mcp: source.mcp?.available || false,
          is_canonical: source.is_canonical || false,
          canonical_source: source.canonical_source ? source.canonical_source.replace(/-/g, '_') : null,
          provides_data_for: source.provides_data_for || [],
          fields: source.fields || [],
          relationships: source.relationships || []
        });

        // Add MCP node if available
        if (source.mcp?.available) {
          const mcpId = `mcp_${nodeId}`;
          if (!nodeIds.has(mcpId)) {
            nodeIds.add(mcpId);
            nodes.push({
              id: mcpId,
              name: `MCP: ${source.name || nodeId}`,
              description: `MCP tools for ${source.name || ''}`,
              category: 'MCP Tools',
              track: 'MCP',
              access_level: 'Public',
              type: 'mcp'
            });
            edges.push({
              source: mcpId,
              target: nodeId,
              type: 'exposes',
              description: `MCP tools for ${source.name || ''}`,
              source_name: `MCP: ${source.name || nodeId}`,
              target_name: source.name || nodeId
            });
          }
        }

        // Add canonical source edge (normalize hyphens to underscores for ID matching)
        if (source.canonical_source) {
          const canonId = source.canonical_source.replace(/-/g, '_');
          if (data.sources.some(s => s.id === canonId)) {
            edges.push({
              source: canonId,
              target: nodeId,
              type: 'provides',
              description: `${source.name} is derived from this canonical source`,
              source_name: data.sources.find(s => s.id === canonId)?.name || canonId,
              target_name: source.name || nodeId,
              is_canonical: true
            });
          }
        }
      }

      // Process relationships
      for (const source of data.sources) {
        for (const rel of (source.relationships || [])) {
          const target = rel.target;
          const through = rel.through;

          // Add target node if not exists
          if (target && !nodeIds.has(target)) {
            nodeIds.add(target);
            nodes.push({
              id: target,
              name: target.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
              description: `Referenced entity: ${target}`,
              category: 'Referenced Entity',
              track: 'Inferred',
              access_level: 'Unknown',
              type: 'entity'
            });
          }

          if (target) {
            edges.push({
              source: source.id,
              target: target,
              type: rel.type || 'related',
              field: rel.field || null,
              through: rel.through || null,
              description: rel.description || '',
              source_name: source.name || source.id,
              target_name: target.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            });
          }

          // Add junction table
          if (through) {
            if (!nodeIds.has(through)) {
              nodeIds.add(through);
              nodes.push({
                id: through,
                name: through.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                description: `Junction table: ${through}`,
                category: 'Junction Table',
                track: source.track || 'Unknown',
                access_level: 'Restricted',
                type: 'junction',
                is_canonical: false,
                canonical_source: null,
                provides_data_for: [],
                fields: [],
                relationships: []
              });
            }
            edges.push({
              source: source.id,
              target: through,
              type: 'has_many_through',
              description: `${source.name || source.id} connects through ${through}`,
              source_name: source.name || source.id,
              target_name: through.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            });
            if (target) {
              edges.push({
                source: through,
                target: target,
                type: 'joins',
                description: `Joins to ${target}`,
                source_name: through.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                target_name: target.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
              });
            }
          }
        }
      }

      return { nodes, edges };
    }

    // Build hierarchy for D3
    function buildHierarchy(data, groupBy) {
      const groups = {};

      data.nodes.forEach(node => {
        const group = node[groupBy] || 'Unknown';
        if (!groups[group]) {
          groups[group] = [];
        }
        groups[group].push(node);
      });

      return {
        name: "ACCESS",
        children: Object.entries(groups).map(([name, children]) => ({
          name,
          children: children.map(c => ({
            name: c.id,
            data: c
          }))
        }))
      };
    }

    // Create the visualization
    function createVisualization() {
      const svg = d3.select("#chart");
      svg.selectAll("*").remove();

      const width = Math.min(800, window.innerWidth - 320);
      const height = Math.min(800, window.innerHeight - 250);
      const radius = Math.min(width, height) / 2 - 120;

      svg.attr("viewBox", [-width / 2, -height / 2, width, height]);

      const hierarchy = buildHierarchy(inventoryData, currentGroupBy);
      const root = d3.hierarchy(hierarchy);

      // Create cluster layout
      const cluster = d3.cluster()
        .size([360, radius]);

      cluster(root);

      // Create a map of nodes by id
      const nodeById = new Map();
      root.leaves().forEach(d => {
        nodeById.set(d.data.name, d);
      });

      // Create links from edges (carry through all metadata)
      const links = inventoryData.edges
        .filter(e => nodeById.has(e.source) && nodeById.has(e.target))
        .map(e => ({
          source: nodeById.get(e.source),
          target: nodeById.get(e.target),
          type: e.type,
          field: e.field || null,
          through: e.through || null,
          description: e.description || '',
          source_name: e.source_name || e.source,
          target_name: e.target_name || e.target,
          is_canonical: e.is_canonical || false
        }));

      // Line generator with configurable tension
      const line = d3.lineRadial()
        .curve(d3.curveBundle.beta(currentTension))
        .radius(d => d.y)
        .angle(d => d.x * Math.PI / 180);

      // Function to get path between two nodes
      function path(source, target) {
        const p = source.path(target);
        return line(p);
      }

      // Draw links (canonical links get dashed style)
      const link = svg.append("g")
        .attr("class", "links")
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("class", d => `link${d.is_canonical ? ' link--canonical' : ''}`)
        .attr("d", d => path(d.source, d.target))
        .on("click", handleLinkClick);

      // Draw nodes
      const node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(root.leaves())
        .join("g")
        .attr("class", "node")
        .attr("transform", d => `rotate(${d.x - 90}) translate(${d.y}, 0)`)
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut)
        .on("click", handleClick);

      // Add circles to nodes
      const colors = colorSchemes[currentGroupBy];
      node.append("circle")
        .attr("r", d => d.data.data?.type === 'data_source' ? 6 : 4)
        .attr("fill", d => {
          const group = d.data.data?.[currentGroupBy] || "Unknown";
          return colors[group] || colors["Unknown"];
        });

      // Add labels
      node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.x < 180 ? 10 : -10)
        .attr("text-anchor", d => d.x < 180 ? "start" : "end")
        .attr("transform", d => d.x >= 180 ? "rotate(180)" : null)
        .text(d => d.data.data?.name || d.data.name);

      // Interaction handlers
      function handleMouseOver(event, d) {
        const sourceLinks = links.filter(l => l.source === d);
        const targetLinks = links.filter(l => l.target === d);

        link.classed("link--source", l => sourceLinks.includes(l))
            .classed("link--target", l => targetLinks.includes(l));

        node.classed("node--source", n => sourceLinks.some(l => l.target === n))
            .classed("node--target", n => targetLinks.some(l => l.source === n));
      }

      function handleMouseOut() {
        link.classed("link--source", false)
            .classed("link--target", false);
        node.classed("node--source", false)
            .classed("node--target", false);
      }

      function handleClick(event, d) {
        const data = d.data.data;
        if (!data) return;

        // Clear FK highlights
        link.classed("link--fk-highlight", false);

        const panel = document.getElementById("infoPanel");
        panel.classList.add("active");

        document.getElementById("infoName").innerHTML = data.name +
          (data.is_canonical ? '<span class="canonical-badge">Authoritative</span>' : '') +
          (!data.is_canonical && data.canonical_source ? '<span class="derived-badge">Derived</span>' : '');
        document.getElementById("infoDesc").textContent = data.description;

        let metaHTML = `
          <span class="tag">${data.track || 'Unknown track'}</span>
          <span class="tag">${data.access_level || 'Unknown access'}</span>
          <span class="tag">${data.type || 'data_source'}</span>
        `;

        // Canonical source note
        if (!data.is_canonical && data.canonical_source) {
          const canonNode = inventoryData.nodes.find(n => n.id === data.canonical_source);
          const canonName = canonNode ? canonNode.name : data.canonical_source;
          metaHTML += `<span class="tag" style="background: var(--access-teal); color: white;">Sourced from: ${canonName}</span>`;
        }
        if (data.is_canonical && data.provides_data_for && data.provides_data_for.length > 0) {
          metaHTML += `<span class="tag" style="background: var(--access-teal); color: white;">Provides data for: ${data.provides_data_for.join(', ')}</span>`;
        }

        const meta = document.getElementById("infoMeta");
        meta.innerHTML = metaHTML;

        // Build ERD-style field card for data sources
        let extraHTML = '';
        if (data.type === 'data_source' && data.fields && data.fields.length > 0) {
          const accessClass = (a) => {
            if (!a) return 'public';
            const lower = a.toLowerCase();
            if (lower === 'internal only') return 'internal';
            return lower;
          };

          let fieldsHTML = data.fields.map(f => {
            let nameHTML = f.name;
            if (f.primary_key) nameHTML += '<span class="pk-badge">PK</span>';
            if (f.references) nameHTML += `<span class="fk-badge" data-ref="${f.references}" title="References: ${f.references}">FK</span>`;
            return `<div class="field-row">
              <span class="field-name">${nameHTML}</span>
              <span class="field-type">${f.type || ''}</span>
              <span class="field-access ${accessClass(f.access)}">${f.access || ''}</span>
            </div>`;
          }).join('');

          extraHTML += `<div class="field-card">
            <div class="field-card-header">
              <span>Fields (${data.fields.length})</span>
              <a href="field-dictionary#${data.id}">View full details</a>
            </div>
            <div class="field-card-body">${fieldsHTML}</div>
          </div>`;

          // Relationships section
          if (data.relationships && data.relationships.length > 0) {
            let relHTML = data.relationships.map(r => {
              const relType = (r.type || '').replace(/_/g, ' ');
              const throughNote = r.through ? ` through <code>${r.through}</code>` : '';
              const fieldNote = r.field ? ` via <code>${r.field}</code>` : '';
              return `<div class="rel-item">
                <span class="rel-type-badge">${relType}</span>
                <strong>${r.target}</strong>${fieldNote}${throughNote}
                <br><span style="color: var(--access-gray);">${r.description || ''}</span>
              </div>`;
            }).join('');

            extraHTML += `<div class="rel-list">
              <h4>Relationships</h4>
              ${relHTML}
            </div>`;
          }
        }

        // Inject extra HTML after meta
        const existingExtra = panel.querySelector('.panel-extra');
        if (existingExtra) existingExtra.remove();
        if (extraHTML) {
          const div = document.createElement('div');
          div.className = 'panel-extra';
          div.innerHTML = extraHTML;
          panel.appendChild(div);

          // FK badge click: highlight the corresponding link
          div.querySelectorAll('.fk-badge').forEach(badge => {
            badge.addEventListener('click', (e) => {
              e.stopPropagation();
              const ref = badge.dataset.ref;
              const refTable = ref.split('.')[0];
              link.classed("link--fk-highlight", l => {
                const srcId = l.source.data?.name || l.source;
                const tgtId = l.target.data?.name || l.target;
                return (srcId === data.id && tgtId === refTable) ||
                       (tgtId === data.id && srcId === refTable);
              });
            });
          });
        }
      }

      function handleLinkClick(event, d) {
        event.stopPropagation();

        // Clear FK highlights
        link.classed("link--fk-highlight", false);

        const panel = document.getElementById("infoPanel");
        panel.classList.add("active");

        const srcName = d.source_name || d.source.data?.data?.name || '?';
        const tgtName = d.target_name || d.target.data?.data?.name || '?';
        const relType = (d.type || 'related').replace(/_/g, ' ');

        document.getElementById("infoName").innerHTML = `<span class="edge-info">${srcName} â†’ ${tgtName}</span>`;

        let descHTML = `<span class="rel-type-badge">${relType}</span>`;
        if (d.is_canonical) {
          descHTML += ' <span class="canonical-badge">Canonical Link</span>';
        }
        document.getElementById("infoDesc").innerHTML = descHTML;

        let metaHTML = '';
        if (d.field) {
          metaHTML += `<span class="tag">Field: <code>${d.field}</code></span>`;
        }
        if (d.through) {
          metaHTML += `<span class="tag">Through: <code>${d.through}</code></span>`;
        }
        if (d.description) {
          metaHTML += `<span class="tag">${d.description}</span>`;
        }
        document.getElementById("infoMeta").innerHTML = metaHTML;

        // Clear extra panel content
        const existingExtra = panel.querySelector('.panel-extra');
        if (existingExtra) existingExtra.remove();

        // Highlight this specific link
        link.classed("link--fk-highlight", l => l === d);
      }

      // Update legend
      updateLegend();
    }

    function updateLegend() {
      const legend = document.getElementById("legend");
      const colors = colorSchemes[currentGroupBy];

      // Get unique groups from nodes
      const activeGroups = new Set(inventoryData.nodes.map(n => n[currentGroupBy] || 'Unknown'));

      legend.innerHTML = Object.entries(colors)
        .filter(([name]) => activeGroups.has(name))
        .map(([name, color]) => `
          <div class="legend-item">
            <div class="legend-color" style="background: ${color}"></div>
            <span>${name}</span>
          </div>
        `).join("") + `
          <div class="legend-item" style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #ddd;">
            <svg width="24" height="14" style="margin-right: 10px; flex-shrink: 0;">
              <line x1="0" y1="7" x2="24" y2="7" stroke="#008597" stroke-width="2" stroke-dasharray="4,2"/>
            </svg>
            <span>Canonical source link</span>
          </div>
        `;

      // Update sidebar header
      const label = currentGroupBy.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      document.querySelector(".sidebar h2").textContent = `Legend - By ${label}`;
    }

    // Event listeners
    document.getElementById("groupBy").addEventListener("change", (e) => {
      currentGroupBy = e.target.value;
      createVisualization();
    });

    document.getElementById("tension").addEventListener("change", (e) => {
      currentTension = parseFloat(e.target.value);
      createVisualization();
    });

    window.addEventListener("resize", createVisualization);
  </script>
</body>
</html>
